<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="apple-touch-icon" sizes="180x180" href="images/ico/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/ico/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/ico/favicon-16x16.png">
    <link rel="manifest" href="images/ico/site.webmanifest">
    <title>Juego de Memoria</title>

    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
        }

        .game-container {
            text-align: center;
            background: #ffffff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            max-width: 90%;
            width: 600px;
        }

        .image-selector {
            display: grid;
            background: #2196F3;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 20px auto;
        }

        .image-option {
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .image-option.selected {
            border-color: #6200ea;
            box-shadow: 0 4px 15px rgba(98, 0, 234, 0.3);
        }

        .image-option img {
            height: 100px;
            object-fit: cover;
        }

        .selection-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px auto;
        }

        .card {
            width: 100%;
            aspect-ratio: 1;
            background: #6200ea;
            border: none;
            padding: 0;
            cursor: pointer;
            border-radius: 8px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card img {
            width: 80%;
            height: 80%;
            object-fit: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            backface-visibility: hidden;
            transform: translate(-50%, -50%) rotateY(180deg);
        }

        .card.flipped {
            transform: rotateY(180deg);
            pointer-events: none;
        }

        .card.matched {
            filter: grayscale(1);
            cursor: default;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 1rem 0;
            font-size: 1.1em;
        }

        #winModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
        }

        .game-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #restart {
            background-color: #2196F3;
            color: white;
        }

        #returnToSelection {
            background-color: #4CAF50;
            color: white;
        }

        #closeModal {
            background-color: #f44336;
            color: white;
            margin-top: 15px;
        }

        button:hover {
            opacity: 0.9;
        }

        @media (max-width: 500px) {
            .grid {
                grid-template-columns: repeat(3, 1fr);
            }
            .game-container {
                width: 90%;
            }
        }
    </style>

    <audio id="flipSound" src="sounds/flipcard.mp3"></audio>
    <audio id="matchSound" src="sounds/12.wav"></audio>
    <audio id="specialSound" src="sounds/especial.mp3"></audio>
</head>
<body>
    <div class="selection-counter" id="counter">
        Seleccionadas: <span>0</span>/8
    </div>
    
    <div class="game-container">
        <h1>Juego de Memoria</h1>
        <div class="image-selector" id="imageSelector"></div>
        <button id="startGame" disabled>Iniciar Juego</button>
        
        <div class="stats" style="display: none;">
            <span>Movimientos: <span id="moves">0</span></span>
            <span>Tiempo: <span id="timer">0:00</span></span>
        </div>
        
        <div class="grid" id="gameGrid" style="display: none;"></div>
        
        <div class="game-buttons">
            <button id="restart" style="display: none;">Reiniciar</button>
            <button id="returnToSelection" style="display: none;">Volver a Seleccionar</button>
        </div>
    </div>

    <div id="winModal">
        <div class="modal-content">
            <h2>¡Felicidades!</h2>
            <p>Has ganado en <span id="finalMoves">0</span> movimientos y <span id="finalTime">0:00</span></p>
            <button id="closeModal">Cerrar</button>
        </div>
    </div>

    <script>
        const predefinedImages = [
            '1.gif', '2.gif', '3.gif', '4.gif', '5.gif',
            '6.gif', '7.gif', '8.gif', '9.gif', '10.gif',
            '11.gif', '12.gif', '13.gif', '14.gif', '15.gif',
            '16.gif', '17.gif', '18.gif', '19.gif', '20.gif', '21.gif'
        ].map(img => `images/${img}`);

        document.addEventListener('DOMContentLoaded', () => {

            // Configuración de sonidos
            const soundSettings = {
                flipVolume: 0.3,
                matchVolume: 0.5,
                globalVolume: 1,
                maxConcurrentSounds: 8, // Máximo de sonidos simultáneos
                activeSounds: []
            };

            // Elementos de audio
            const flipSound = document.getElementById('flipSound');

            const gameState = {
                moves: 0,
                timer: 0,
                lockBoard: false,
                matchedPairs: 0,
                firstCard: null,
                secondCard: null,
                selectedImages: new Set(),
                timerInterval: null
            };

            const elements = {
                imageSelector: document.getElementById('imageSelector'),
                startButton: document.getElementById('startGame'),
                counter: document.querySelector('#counter span'),
                stats: document.querySelector('.stats'),
                gameGrid: document.getElementById('gameGrid'),
                restartButton: document.getElementById('restart'),
                returnButton: document.getElementById('returnToSelection'),
                movesCounter: document.getElementById('moves'),
                timerDisplay: document.getElementById('timer'),
                winModal: document.getElementById('winModal'),
                finalMoves: document.getElementById('finalMoves'),
                finalTime: document.getElementById('finalTime'),
                closeModal: document.getElementById('closeModal')
            };

            // Cargar selector de imágenes
            predefinedImages.forEach(imgSrc => {
                const div = document.createElement('div');
                div.className = 'image-option';
                div.innerHTML = `<img src="${imgSrc}" alt="Opción de imagen" loading="lazy">`;
                div.addEventListener('click', () => toggleImageSelection(imgSrc, div));
                elements.imageSelector.appendChild(div);
            });

            function toggleImageSelection(imgSrc, element) {
                if (gameState.selectedImages.has(imgSrc)) {
                    gameState.selectedImages.delete(imgSrc);
                    element.classList.remove('selected');
                } else {
                    if (gameState.selectedImages.size >= 8) return;
                    gameState.selectedImages.add(imgSrc);
                    element.classList.add('selected');
                }
                updateSelectionUI();
            }

            function updateSelectionUI() {
                elements.counter.textContent = gameState.selectedImages.size;
                elements.startButton.disabled = gameState.selectedImages.size !== 8;
            }

            elements.startButton.addEventListener('click', () => {
                elements.imageSelector.style.display = 'none';
                elements.startButton.style.display = 'none';
                elements.stats.style.display = 'flex';
                elements.gameGrid.style.display = 'grid';
                elements.restartButton.style.display = 'block';
                elements.returnButton.style.display = 'block';
                initializeGame(Array.from(gameState.selectedImages));
            });

            elements.restartButton.addEventListener('click', () => {
                resetGame();
                initializeGame(Array.from(gameState.selectedImages));
            });

            elements.returnButton.addEventListener('click', returnToSelection);
            
            elements.closeModal.addEventListener('click', () => {
                elements.winModal.style.display = 'none';
            });

            function returnToSelection() {
                resetGame();
                elements.imageSelector.style.display = 'grid';
                elements.startButton.style.display = 'block';
                elements.stats.style.display = 'none';
                elements.gameGrid.style.display = 'none';
                elements.restartButton.style.display = 'none';
                elements.returnButton.style.display = 'none';
                gameState.selectedImages.clear();
                document.querySelectorAll('.image-option').forEach(option => {
                    option.classList.remove('selected');
                });
                updateSelectionUI();
                elements.winModal.style.display = 'none';
            }

            async function initializeGame(selectedImages) {
                resetGame();
                await createBoard(selectedImages);
                startTimer();
            }

            function resetGame() {
                clearInterval(gameState.timerInterval);
                gameState.moves = 0;
                gameState.timer = 0;
                gameState.matchedPairs = 0;
                gameState.firstCard = null;
                gameState.secondCard = null;
                gameState.lockBoard = false;
                elements.movesCounter.textContent = '0';
                elements.timerDisplay.textContent = '0:00';
                elements.gameGrid.innerHTML = '';
            }

            function startTimer() {
                gameState.timerInterval = setInterval(() => {
                    gameState.timer++;
                    elements.timerDisplay.textContent = formatTime(gameState.timer);
                }, 1000);
            }

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            async function createBoard(images) {
                elements.gameGrid.innerHTML = '';
                
                await Promise.all(images.map(src => 
                    new Promise(resolve => {
                        const img = new Image();
                        img.src = src;
                        img.onload = resolve;
                    })
                ))
                
                const cards = shuffle([...images, ...images]);
                
                cards.forEach(image => {
                    const card = document.createElement('button');
                    card.className = 'card';
                    card.dataset.image = image;
                    card.innerHTML = `<img src="${image}" alt="Imagen del juego">`;
                    card.addEventListener('click', () => handleCardClick(card));
                    elements.gameGrid.appendChild(card);
                });
            }

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function handleCardClick(card) {
                if (gameState.lockBoard || card === gameState.firstCard || card.classList.contains('matched')) return;
                
                flipCard(card);
                
                if (!gameState.firstCard) {
                    gameState.firstCard = card;
                    return;
                }
                
                gameState.secondCard = card;
                gameState.lockBoard = true;
                checkMatch();
            }

            // Función para reproducir sonidos superpuestos
            function playSound(soundPath, volumeMultiplier = 1) {
                try {
                    if(soundSettings.activeSounds.length >= soundSettings.maxConcurrentSounds) return;
                    
                    const audio = new Audio(soundPath);
                    audio.volume = soundSettings.globalVolume * volumeMultiplier;
                    
                    audio.addEventListener('play', () => {
                        soundSettings.activeSounds.push(audio);
                    });
                    
                    audio.addEventListener('ended', () => {
                        soundSettings.activeSounds = soundSettings.activeSounds.filter(s => s !== audio);
                    });
                    
                    audio.play().catch(error => console.error('Error al reproducir:', error));
                    
                } catch(error) {
                    console.error('Error al cargar sonido:', error);
                }
            }

            function flipCard(card) {
                // Reproducir sonido al voltear
                // flipSound.currentTime = 0;
                // flipSound.volume = 0.2; // Ejemplo: 50% de volumen
                // flipSound.play();
                playSound('sounds/flipcard.mp3', soundSettings.flipVolume);
                card.classList.add('flipped');
            }

            function checkMatch() {
                gameState.moves++;
                elements.movesCounter.textContent = gameState.moves;
                
                const isMatch = gameState.firstCard.dataset.image === gameState.secondCard.dataset.image;
                
                if (isMatch) {
                    gameState.matchedPairs++;
                    const imageNumber = gameState.firstCard.dataset.image.split('/').pop().split('.')[0];
                    playSound(`sounds/${imageNumber}.wav`, soundSettings.matchVolume);
                    // Reproducir sonido específico para la imagen
                    // const sound = getMatchSound(gameState.firstCard.dataset.image);
                    // sound.play();

                    // Efecto rítmico visual
                    gameState.firstCard.style.transform = 'rotateY(180deg) scale(1.1)';
                    gameState.secondCard.style.transform = 'rotateY(180deg) scale(1.1)';
                    setTimeout(() => {
                        gameState.firstCard.style.transform = 'rotateY(180deg)';
                        gameState.secondCard.style.transform = 'rotateY(180deg)';
                    }, 200);
                    
                    // Marcar cartas como emparejadas
                    // gameState.firstCard.classList.add('matched');
                    // gameState.secondCard.classList.add('matched');
                }

                setTimeout(() => {
                    if (!isMatch) {
                        gameState.firstCard.classList.remove('flipped');
                        gameState.secondCard.classList.remove('flipped');
                    }
                    resetBoard();
                }, 1000);
            }

            function resetBoard() {
                gameState.firstCard = null;
                gameState.secondCard = null;
                gameState.lockBoard = false;
                
                if (gameState.matchedPairs === gameState.selectedImages.size) {
                    clearInterval(gameState.timerInterval);
                    showWinModal();
                }
            }

            function showWinModal() {
                elements.finalMoves.textContent = gameState.moves;
                elements.finalTime.textContent = formatTime(gameState.timer);
                elements.winModal.style.display = 'flex';
            }

            // Función para obtener el sonido correspondiente
            function getMatchSound(imagePath) {
                const imageNumber = imagePath.split('/').pop().split('.')[0];
                return new Audio(`sounds/${imageNumber}.wav`);
            }
        });
    </script>
</body>
</html>